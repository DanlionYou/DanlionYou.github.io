import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,f as n,o as l}from"./app-utPN4a2m.js";const t={};function e(h,i){return l(),a("div",null,i[0]||(i[0]=[n(`<p>ä¹è§‚é”å’Œæ‚²è§‚é”çš„ä»‹ç»ä»¥åŠä¹è§‚é”å¸¸è§å®ç°æ–¹å¼å¯ä»¥é˜…è¯»ç¬”è€…å†™çš„è¿™ç¯‡æ–‡ç« ï¼š<a href="https://javaguide.cn/java/concurrent/optimistic-lock-and-pessimistic-lock.html" target="_blank" rel="noopener noreferrer">ä¹è§‚é”å’Œæ‚²è§‚é”è¯¦è§£</a>ã€‚</p><p>è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç» ï¼šJava ä¸­ CAS çš„å®ç°ä»¥åŠ CAS å­˜åœ¨çš„ä¸€äº›é—®é¢˜ã€‚</p><h2 id="java-ä¸­-cas-æ˜¯å¦‚ä½•å®ç°çš„" tabindex="-1"><a class="header-anchor" href="#java-ä¸­-cas-æ˜¯å¦‚ä½•å®ç°çš„"><span>Java ä¸­ CAS æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</span></a></h2><p>åœ¨ Java ä¸­ï¼Œå®ç° CASï¼ˆCompare-And-Swap, æ¯”è¾ƒå¹¶äº¤æ¢ï¼‰æ“ä½œçš„ä¸€ä¸ªå…³é”®ç±»æ˜¯<code>Unsafe</code>ã€‚</p><p><code>Unsafe</code>ç±»ä½äº<code>sun.misc</code>åŒ…ä¸‹ï¼Œæ˜¯ä¸€ä¸ªæä¾›ä½çº§åˆ«ã€ä¸å®‰å…¨æ“ä½œçš„ç±»ã€‚ç”±äºå…¶å¼ºå¤§çš„åŠŸèƒ½å’Œæ½œåœ¨çš„å±é™©æ€§ï¼Œå®ƒé€šå¸¸ç”¨äº JVM å†…éƒ¨æˆ–ä¸€äº›éœ€è¦æé«˜æ€§èƒ½å’Œåº•å±‚è®¿é—®çš„åº“ä¸­ï¼Œè€Œä¸æ¨èæ™®é€šå¼€å‘è€…åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ã€‚å…³äº <code>Unsafe</code>ç±»çš„è¯¦ç»†ä»‹ç»ï¼Œå¯ä»¥é˜…è¯»è¿™ç¯‡æ–‡ç« ï¼šğŸ“Œ<a href="https://javaguide.cn/java/basis/unsafe.html" target="_blank" rel="noopener noreferrer">Java é­”æ³•ç±» Unsafe è¯¦è§£</a>ã€‚</p><p><code>sun.misc</code>åŒ…ä¸‹çš„<code>Unsafe</code>ç±»æä¾›äº†<code>compareAndSwapObject</code>ã€<code>compareAndSwapInt</code>ã€<code>compareAndSwapLong</code>æ–¹æ³•æ¥å®ç°çš„å¯¹<code>Object</code>ã€<code>int</code>ã€<code>long</code>ç±»å‹çš„ CAS æ“ä½œï¼š</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">/**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> * ä»¥åŸå­æ–¹å¼æ›´æ–°å¯¹è±¡å­—æ®µçš„å€¼ã€‚</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> *</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> * </span><span style="--shiki-light:#A626A4;--shiki-light-font-style:italic;--shiki-dark:#C678DD;--shiki-dark-font-style:italic;">@param</span><span style="--shiki-light:#383A42;--shiki-light-font-style:italic;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> o</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        è¦æ“ä½œçš„å¯¹è±¡</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> * </span><span style="--shiki-light:#A626A4;--shiki-light-font-style:italic;--shiki-dark:#C678DD;--shiki-dark-font-style:italic;">@param</span><span style="--shiki-light:#383A42;--shiki-light-font-style:italic;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> offset</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   å¯¹è±¡å­—æ®µçš„å†…å­˜åç§»é‡</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> * </span><span style="--shiki-light:#A626A4;--shiki-light-font-style:italic;--shiki-dark:#C678DD;--shiki-dark-font-style:italic;">@param</span><span style="--shiki-light:#383A42;--shiki-light-font-style:italic;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> expected</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> æœŸæœ›çš„æ—§å€¼</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> * </span><span style="--shiki-light:#A626A4;--shiki-light-font-style:italic;--shiki-dark:#C678DD;--shiki-dark-font-style:italic;">@param</span><span style="--shiki-light:#383A42;--shiki-light-font-style:italic;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> x</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        è¦è®¾ç½®çš„æ–°å€¼</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> * </span><span style="--shiki-light:#A626A4;--shiki-light-font-style:italic;--shiki-dark:#C678DD;--shiki-dark-font-style:italic;">@return</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> å¦‚æœå€¼è¢«æˆåŠŸæ›´æ–°ï¼Œåˆ™è¿”å› trueï¼›å¦åˆ™è¿”å› false</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">boolean</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> compareAndSwapObject</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Object</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> o</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> long</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Object</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> expected</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Object</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> x)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">/**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> * ä»¥åŸå­æ–¹å¼æ›´æ–° int ç±»å‹çš„å¯¹è±¡å­—æ®µçš„å€¼ã€‚</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">boolean</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> compareAndSwapInt</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Object</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> o</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> long</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> expected</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> x)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">/**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> * ä»¥åŸå­æ–¹å¼æ›´æ–° long ç±»å‹çš„å¯¹è±¡å­—æ®µçš„å€¼ã€‚</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">boolean</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> compareAndSwapLong</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Object</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> o</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> long</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> long</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> expected</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> long</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> x)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Unsafe</code>ç±»ä¸­çš„ CAS æ–¹æ³•æ˜¯<code>native</code>æ–¹æ³•ã€‚<code>native</code>å…³é”®å­—è¡¨æ˜è¿™äº›æ–¹æ³•æ˜¯ç”¨æœ¬åœ°ä»£ç ï¼ˆé€šå¸¸æ˜¯ C æˆ– C++ï¼‰å®ç°çš„ï¼Œè€Œä¸æ˜¯ç”¨ Java å®ç°çš„ã€‚è¿™äº›æ–¹æ³•ç›´æ¥è°ƒç”¨åº•å±‚çš„ç¡¬ä»¶æŒ‡ä»¤æ¥å®ç°åŸå­æ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒJava è¯­è¨€å¹¶æ²¡æœ‰ç›´æ¥ç”¨ Java å®ç° CASã€‚</p><p>æ›´å‡†ç¡®ç‚¹æ¥è¯´ï¼ŒJava ä¸­ CAS æ˜¯ C++ å†…è”æ±‡ç¼–çš„å½¢å¼å®ç°çš„ï¼Œé€šè¿‡ JNIï¼ˆJava Native Interfaceï¼‰ è°ƒç”¨ã€‚å› æ­¤ï¼ŒCAS çš„å…·ä½“å®ç°ä¸æ“ä½œç³»ç»Ÿä»¥åŠ CPU å¯†åˆ‡ç›¸å…³ã€‚</p><p><code>java.util.concurrent.atomic</code> åŒ…æä¾›äº†ä¸€äº›ç”¨äºåŸå­æ“ä½œçš„ç±»ã€‚</p><p><img src="https://oss.javaguide.cn/github/javaguide/java/JUCåŸå­ç±»æ¦‚è§ˆ.png" alt="JUCåŸå­ç±»æ¦‚è§ˆ"></p><p>å…³äºè¿™äº› Atomic åŸå­ç±»çš„ä»‹ç»å’Œä½¿ç”¨ï¼Œå¯ä»¥é˜…è¯»è¿™ç¯‡æ–‡ç« ï¼š<a href="https://javaguide.cn/java/concurrent/atomic-classes.html" target="_blank" rel="noopener noreferrer">Atomic åŸå­ç±»æ€»ç»“</a>ã€‚</p><p>Atomic ç±»ä¾èµ–äº CAS ä¹è§‚é”æ¥ä¿è¯å…¶æ–¹æ³•çš„åŸå­æ€§ï¼Œè€Œä¸éœ€è¦ä½¿ç”¨ä¼ ç»Ÿçš„é”æœºåˆ¶ï¼ˆå¦‚ <code>synchronized</code> å—æˆ– <code>ReentrantLock</code>ï¼‰ã€‚</p><p><code>AtomicInteger</code>æ˜¯ Java çš„åŸå­ç±»ä¹‹ä¸€ï¼Œä¸»è¦ç”¨äºå¯¹ <code>int</code> ç±»å‹çš„å˜é‡è¿›è¡ŒåŸå­æ“ä½œï¼Œå®ƒåˆ©ç”¨<code>Unsafe</code>ç±»æä¾›çš„ä½çº§åˆ«åŸå­æ“ä½œæ–¹æ³•å®ç°æ— é”çš„çº¿ç¨‹å®‰å…¨æ€§ã€‚</p><p>ä¸‹é¢ï¼Œæˆ‘ä»¬é€šè¿‡è§£è¯»<code>AtomicInteger</code>çš„æ ¸å¿ƒæºç ï¼ˆJDK1.8ï¼‰ï¼Œæ¥è¯´æ˜ Java å¦‚ä½•ä½¿ç”¨<code>Unsafe</code>ç±»çš„æ–¹æ³•æ¥å®ç°åŸå­æ“ä½œã€‚</p><p><code>AtomicInteger</code>æ ¸å¿ƒæºç å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// è·å– Unsafe å®ä¾‹</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Unsafe</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> unsafe </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> Unsafe</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getUnsafe</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> long</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> valueOffset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">static</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    try</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // è·å–â€œvalueâ€å­—æ®µåœ¨AtomicIntegerç±»ä¸­çš„å†…å­˜åç§»é‡</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        valueOffset </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> unsafe</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">objectFieldOffset</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">            (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">AtomicInteger</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getDeclaredField</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;value&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Exception</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> ex</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) { </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">throw</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> Error</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(ex)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// ç¡®ä¿â€œvalueâ€å­—æ®µçš„å¯è§æ€§</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> volatile</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// å¦‚æœå½“å‰å€¼ç­‰äºé¢„æœŸå€¼ï¼Œåˆ™åŸå­åœ°å°†å€¼è®¾ç½®ä¸ºnewValue</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// ä½¿ç”¨ Unsafe#compareAndSwapInt æ–¹æ³•è¿›è¡ŒCASæ“ä½œ</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> boolean</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> compareAndSet</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> expect</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> update) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> unsafe</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">compareAndSwapInt</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, valueOffset, expect, update);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// åŸå­åœ°å°†å½“å‰å€¼åŠ  delta å¹¶è¿”å›æ—§å€¼</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getAndAdd</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> delta) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> unsafe</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getAndAddInt</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, valueOffset, delta);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// åŸå­åœ°å°†å½“å‰å€¼åŠ  1 å¹¶è¿”å›åŠ ä¹‹å‰çš„å€¼ï¼ˆæ—§å€¼ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// ä½¿ç”¨ Unsafe#getAndAddInt æ–¹æ³•è¿›è¡ŒCASæ“ä½œã€‚</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getAndIncrement</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">() {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> unsafe</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getAndAddInt</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, valueOffset, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// åŸå­åœ°å°†å½“å‰å€¼å‡ 1 å¹¶è¿”å›å‡ä¹‹å‰çš„å€¼ï¼ˆæ—§å€¼ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getAndDecrement</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">() {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> unsafe</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getAndAddInt</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, valueOffset, </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Unsafe#getAndAddInt</code>æºç ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// åŸå­åœ°è·å–å¹¶å¢åŠ æ•´æ•°å€¼</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getAndAddInt</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Object</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> o</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> long</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> delta) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> v</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    do</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // ä»¥ volatile æ–¹å¼è·å–å¯¹è±¡ o åœ¨å†…å­˜åç§»é‡ offset å¤„çš„æ•´æ•°å€¼</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        v </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getIntVolatile</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(o</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> offset)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">while</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">compareAndSwapInt</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(o</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> v</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> v </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> delta))</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // è¿”å›æ—§å€¼</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> v</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>getAndAddInt</code> ä½¿ç”¨äº† <code>do-while</code> å¾ªç¯ï¼šåœ¨<code>compareAndSwapInt</code>æ“ä½œå¤±è´¥æ—¶ï¼Œä¼šä¸æ–­é‡è¯•ç›´åˆ°æˆåŠŸã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>getAndAddInt</code>æ–¹æ³•ä¼šé€šè¿‡ <code>compareAndSwapInt</code> æ–¹æ³•æ¥å°è¯•æ›´æ–° <code>value</code> çš„å€¼ï¼Œå¦‚æœæ›´æ–°å¤±è´¥ï¼ˆå½“å‰å€¼åœ¨æ­¤æœŸé—´è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼‰ï¼Œå®ƒä¼šé‡æ–°è·å–å½“å‰å€¼å¹¶å†æ¬¡å°è¯•æ›´æ–°ï¼Œç›´åˆ°æ“ä½œæˆåŠŸã€‚</p><p>ç”±äº CAS æ“ä½œå¯èƒ½ä¼šå› ä¸ºå¹¶å‘å†²çªè€Œå¤±è´¥ï¼Œå› æ­¤é€šå¸¸ä¼šä¸<code>while</code>å¾ªç¯æ­é…ä½¿ç”¨ï¼Œåœ¨å¤±è´¥åä¸æ–­é‡è¯•ï¼Œç›´åˆ°æ“ä½œæˆåŠŸã€‚è¿™å°±æ˜¯ <strong>è‡ªæ—‹é”æœºåˆ¶</strong> ã€‚</p><h2 id="cas-ç®—æ³•å­˜åœ¨å“ªäº›é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#cas-ç®—æ³•å­˜åœ¨å“ªäº›é—®é¢˜"><span>CAS ç®—æ³•å­˜åœ¨å“ªäº›é—®é¢˜ï¼Ÿ</span></a></h2><p>ABA é—®é¢˜æ˜¯ CAS ç®—æ³•æœ€å¸¸è§çš„é—®é¢˜ã€‚</p><h3 id="aba-é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#aba-é—®é¢˜"><span>ABA é—®é¢˜</span></a></h3><p>å¦‚æœä¸€ä¸ªå˜é‡ V åˆæ¬¡è¯»å–çš„æ—¶å€™æ˜¯ A å€¼ï¼Œå¹¶ä¸”åœ¨å‡†å¤‡èµ‹å€¼çš„æ—¶å€™æ£€æŸ¥åˆ°å®ƒä»ç„¶æ˜¯ A å€¼ï¼Œé‚£æˆ‘ä»¬å°±èƒ½è¯´æ˜å®ƒçš„å€¼æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¿‡äº†å—ï¼Ÿå¾ˆæ˜æ˜¾æ˜¯ä¸èƒ½çš„ï¼Œå› ä¸ºåœ¨è¿™æ®µæ—¶é—´å®ƒçš„å€¼å¯èƒ½è¢«æ”¹ä¸ºå…¶ä»–å€¼ï¼Œç„¶ååˆæ”¹å› Aï¼Œé‚£ CAS æ“ä½œå°±ä¼šè¯¯è®¤ä¸ºå®ƒä»æ¥æ²¡æœ‰è¢«ä¿®æ”¹è¿‡ã€‚è¿™ä¸ªé—®é¢˜è¢«ç§°ä¸º CAS æ“ä½œçš„ <strong>&quot;ABA&quot;é—®é¢˜ã€‚</strong></p><p>ABA é—®é¢˜çš„è§£å†³æ€è·¯æ˜¯åœ¨å˜é‡å‰é¢è¿½åŠ ä¸Š<strong>ç‰ˆæœ¬å·æˆ–è€…æ—¶é—´æˆ³</strong>ã€‚JDK 1.5 ä»¥åçš„ <code>AtomicStampedReference</code> ç±»å°±æ˜¯ç”¨æ¥è§£å†³ ABA é—®é¢˜çš„ï¼Œå…¶ä¸­çš„ <code>compareAndSet()</code> æ–¹æ³•å°±æ˜¯é¦–å…ˆæ£€æŸ¥å½“å‰å¼•ç”¨æ˜¯å¦ç­‰äºé¢„æœŸå¼•ç”¨ï¼Œå¹¶ä¸”å½“å‰æ ‡å¿—æ˜¯å¦ç­‰äºé¢„æœŸæ ‡å¿—ï¼Œå¦‚æœå…¨éƒ¨ç›¸ç­‰ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°†è¯¥å¼•ç”¨å’Œè¯¥æ ‡å¿—çš„å€¼è®¾ç½®ä¸ºç»™å®šçš„æ›´æ–°å€¼ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> boolean</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> compareAndSet</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">V</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">   expectedReference</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">                             V</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">   newReference</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                             int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> expectedStamp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                             int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> newStamp) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    Pair</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">V</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> current </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> pair</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        expectedReference </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> current</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">reference</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        expectedStamp </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> current</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">stamp</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        ((newReference </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> current</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">reference</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">          newStamp </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> current</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">stamp</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">||</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">         casPair</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(current</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> Pair</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">of</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(newReference, newStamp)</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">))</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§" tabindex="-1"><a class="header-anchor" href="#å¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§"><span>å¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§</span></a></h3><p>CAS ç»å¸¸ä¼šç”¨åˆ°è‡ªæ—‹æ“ä½œæ¥è¿›è¡Œé‡è¯•ï¼Œä¹Ÿå°±æ˜¯ä¸æˆåŠŸå°±ä¸€ç›´å¾ªç¯æ‰§è¡Œç›´åˆ°æˆåŠŸã€‚å¦‚æœé•¿æ—¶é—´ä¸æˆåŠŸï¼Œä¼šç»™ CPU å¸¦æ¥éå¸¸å¤§çš„æ‰§è¡Œå¼€é”€ã€‚</p><p>å¦‚æœ JVM èƒ½å¤Ÿæ”¯æŒå¤„ç†å™¨æä¾›çš„<code>pause</code>æŒ‡ä»¤ï¼Œé‚£ä¹ˆè‡ªæ—‹æ“ä½œçš„æ•ˆç‡å°†æœ‰æ‰€æå‡ã€‚<code>pause</code>æŒ‡ä»¤æœ‰ä¸¤ä¸ªé‡è¦ä½œç”¨ï¼š</p><ol><li><strong>å»¶è¿Ÿæµæ°´çº¿æ‰§è¡ŒæŒ‡ä»¤</strong>ï¼š<code>pause</code>æŒ‡ä»¤å¯ä»¥å»¶è¿ŸæŒ‡ä»¤çš„æ‰§è¡Œï¼Œä»è€Œå‡å°‘ CPU çš„èµ„æºæ¶ˆè€—ã€‚å…·ä½“çš„å»¶è¿Ÿæ—¶é—´å–å†³äºå¤„ç†å™¨çš„å®ç°ç‰ˆæœ¬ï¼Œåœ¨æŸäº›å¤„ç†å™¨ä¸Šï¼Œå»¶è¿Ÿæ—¶é—´å¯èƒ½ä¸ºé›¶ã€‚</li><li><strong>é¿å…å†…å­˜é¡ºåºå†²çª</strong>ï¼šåœ¨é€€å‡ºå¾ªç¯æ—¶ï¼Œ<code>pause</code>æŒ‡ä»¤å¯ä»¥é¿å…ç”±äºå†…å­˜é¡ºåºå†²çªè€Œå¯¼è‡´çš„ CPU æµæ°´çº¿è¢«æ¸…ç©ºï¼Œä»è€Œæé«˜ CPU çš„æ‰§è¡Œæ•ˆç‡ã€‚</li></ol><h3 id="åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œ" tabindex="-1"><a class="header-anchor" href="#åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œ"><span>åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œ</span></a></h3><p>CAS æ“ä½œä»…èƒ½å¯¹å•ä¸ªå…±äº«å˜é‡æœ‰æ•ˆã€‚å½“éœ€è¦æ“ä½œå¤šä¸ªå…±äº«å˜é‡æ—¶ï¼ŒCAS å°±æ˜¾å¾—æ— èƒ½ä¸ºåŠ›ã€‚ä¸è¿‡ï¼Œä» JDK 1.5 å¼€å§‹ï¼ŒJava æä¾›äº†<code>AtomicReference</code>ç±»ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿä¿è¯å¼•ç”¨å¯¹è±¡ä¹‹é—´çš„åŸå­æ€§ã€‚é€šè¿‡å°†å¤šä¸ªå˜é‡å°è£…åœ¨ä¸€ä¸ªå¯¹è±¡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>AtomicReference</code>æ¥æ‰§è¡Œ CAS æ“ä½œã€‚</p><p>é™¤äº† <code>AtomicReference</code> è¿™ç§æ–¹å¼ä¹‹å¤–ï¼Œè¿˜å¯ä»¥åˆ©ç”¨åŠ é”æ¥ä¿è¯ã€‚</p><h2 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“"><span>æ€»ç»“</span></a></h2><p>åœ¨ Java ä¸­ï¼ŒCAS é€šè¿‡ <code>Unsafe</code> ç±»ä¸­çš„ <code>native</code> æ–¹æ³•å®ç°ï¼Œè¿™äº›æ–¹æ³•è°ƒç”¨åº•å±‚çš„ç¡¬ä»¶æŒ‡ä»¤æ¥å®ŒæˆåŸå­æ“ä½œã€‚ç”±äºå…¶å®ç°ä¾èµ–äº C++ å†…è”æ±‡ç¼–å’Œ JNI è°ƒç”¨ï¼Œå› æ­¤ CAS çš„å…·ä½“å®ç°ä¸æ“ä½œç³»ç»Ÿä»¥åŠ CPU å¯†åˆ‡ç›¸å…³ã€‚</p><p>CAS è™½ç„¶å…·æœ‰é«˜æ•ˆçš„æ— é”ç‰¹æ€§ï¼Œä½†ä¹Ÿéœ€è¦æ³¨æ„ ABA ã€å¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§ç­‰é—®é¢˜ã€‚</p>`,37)]))}const d=s(t,[["render",e],["__file","cas.html.vue"]]),r=JSON.parse('{"path":"/java/concurrent/cas.html","title":"CAS è¯¦è§£","lang":"zh-CN","frontmatter":{"title":"CAS è¯¦è§£","category":"Java","tag":["Javaå¹¶å‘"],"description":"ä¹è§‚é”å’Œæ‚²è§‚é”çš„ä»‹ç»ä»¥åŠä¹è§‚é”å¸¸è§å®ç°æ–¹å¼å¯ä»¥é˜…è¯»ç¬”è€…å†™çš„è¿™ç¯‡æ–‡ç« ï¼šä¹è§‚é”å’Œæ‚²è§‚é”è¯¦è§£ã€‚ è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç» ï¼šJava ä¸­ CAS çš„å®ç°ä»¥åŠ CAS å­˜åœ¨çš„ä¸€äº›é—®é¢˜ã€‚ Java ä¸­ CAS æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ åœ¨ Java ä¸­ï¼Œå®ç° CASï¼ˆCompare-And-Swap, æ¯”è¾ƒå¹¶äº¤æ¢ï¼‰æ“ä½œçš„ä¸€ä¸ªå…³é”®ç±»æ˜¯Unsafeã€‚ Unsafeç±»ä½äºsun.mis...","head":[["meta",{"property":"og:url","content":"https://javaguide.cn/java/concurrent/cas.html"}],["meta",{"property":"og:site_name","content":"JavaGuide"}],["meta",{"property":"og:title","content":"CAS è¯¦è§£"}],["meta",{"property":"og:description","content":"ä¹è§‚é”å’Œæ‚²è§‚é”çš„ä»‹ç»ä»¥åŠä¹è§‚é”å¸¸è§å®ç°æ–¹å¼å¯ä»¥é˜…è¯»ç¬”è€…å†™çš„è¿™ç¯‡æ–‡ç« ï¼šä¹è§‚é”å’Œæ‚²è§‚é”è¯¦è§£ã€‚ è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç» ï¼šJava ä¸­ CAS çš„å®ç°ä»¥åŠ CAS å­˜åœ¨çš„ä¸€äº›é—®é¢˜ã€‚ Java ä¸­ CAS æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ åœ¨ Java ä¸­ï¼Œå®ç° CASï¼ˆCompare-And-Swap, æ¯”è¾ƒå¹¶äº¤æ¢ï¼‰æ“ä½œçš„ä¸€ä¸ªå…³é”®ç±»æ˜¯Unsafeã€‚ Unsafeç±»ä½äºsun.mis..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://oss.javaguide.cn/github/javaguide/java/JUC%E5%8E%9F%E5%AD%90%E7%B1%BB%E6%A6%82%E8%A7%88.png"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-07-21T04:56:33.000Z"}],["meta",{"property":"article:tag","content":"Javaå¹¶å‘"}],["meta",{"property":"article:modified_time","content":"2024-07-21T04:56:33.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"CAS è¯¦è§£\\",\\"image\\":[\\"https://oss.javaguide.cn/github/javaguide/java/JUC%E5%8E%9F%E5%AD%90%E7%B1%BB%E6%A6%82%E8%A7%88.png\\"],\\"dateModified\\":\\"2024-07-21T04:56:33.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Guide\\",\\"url\\":\\"https://javaguide.cn/article/\\"}]}"]]},"headers":[{"level":2,"title":"Java ä¸­ CAS æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ","slug":"java-ä¸­-cas-æ˜¯å¦‚ä½•å®ç°çš„","link":"#java-ä¸­-cas-æ˜¯å¦‚ä½•å®ç°çš„","children":[]},{"level":2,"title":"CAS ç®—æ³•å­˜åœ¨å“ªäº›é—®é¢˜ï¼Ÿ","slug":"cas-ç®—æ³•å­˜åœ¨å“ªäº›é—®é¢˜","link":"#cas-ç®—æ³•å­˜åœ¨å“ªäº›é—®é¢˜","children":[{"level":3,"title":"ABA é—®é¢˜","slug":"aba-é—®é¢˜","link":"#aba-é—®é¢˜","children":[]},{"level":3,"title":"å¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§","slug":"å¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§","link":"#å¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§","children":[]},{"level":3,"title":"åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œ","slug":"åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œ","link":"#åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œ","children":[]}]},{"level":2,"title":"æ€»ç»“","slug":"æ€»ç»“","link":"#æ€»ç»“","children":[]}],"git":{"createdTime":1721192000000,"updatedTime":1721537793000,"contributors":[{"name":"Guide","username":"Guide","email":"koushuangbwcx@163.com","commits":2,"url":"https://github.com/Guide"}]},"readingTime":{"minutes":6.23,"words":1870},"filePathRelative":"java/concurrent/cas.md","localizedDate":"2024å¹´7æœˆ17æ—¥","excerpt":"<p>ä¹è§‚é”å’Œæ‚²è§‚é”çš„ä»‹ç»ä»¥åŠä¹è§‚é”å¸¸è§å®ç°æ–¹å¼å¯ä»¥é˜…è¯»ç¬”è€…å†™çš„è¿™ç¯‡æ–‡ç« ï¼š<a href=\\"https://javaguide.cn/java/concurrent/optimistic-lock-and-pessimistic-lock.html\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">ä¹è§‚é”å’Œæ‚²è§‚é”è¯¦è§£</a>ã€‚</p>\\n<p>è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç» ï¼šJava ä¸­ CAS çš„å®ç°ä»¥åŠ CAS å­˜åœ¨çš„ä¸€äº›é—®é¢˜ã€‚</p>\\n<h2>Java ä¸­ CAS æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</h2>\\n<p>åœ¨ Java ä¸­ï¼Œå®ç° CASï¼ˆCompare-And-Swap, æ¯”è¾ƒå¹¶äº¤æ¢ï¼‰æ“ä½œçš„ä¸€ä¸ªå…³é”®ç±»æ˜¯<code>Unsafe</code>ã€‚</p>","autoDesc":true}');export{d as comp,r as data};
